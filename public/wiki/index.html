<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shared Wiki (MVP)</title>
  <style>
    body { margin: 0; font-family: sans-serif; background: #f7f2ea; color: #2c1f16; }
    header { padding: 16px 20px; background: #fffdf7; border-bottom: 1px solid #e2d7c7; }
    main { padding: 16px 20px; max-width: 900px; }
    .card { background: #fffdf7; border: 1px solid #e2d7c7; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    h2 { margin: 0 0 8px; font-size: 18px; }
    p { margin: 0 0 8px; }
  </style>
</head>
<body>
  <header>
    <h1>Shared Wiki (MVP)</h1>
    <p>Renders <code>wiki.append</code> events from <code>data/events.jsonl</code>.</p>
  </header>
  <main>
    <div class="card" id="content"></div>
    <div class="card">
      <strong>Transport:</strong> <span id="transport-status">connecting</span>
    </div>
    <div class="card">
      <h2>Share</h2>
      <div class="row">
        <div>
          <label for="share-link">Link</label>
          <input id="share-link" readonly />
        </div>
        <div>
          <label>QR</label>
          <div id="share-qr"></div>
        </div>
      </div>
    </div>
    <div class="card">
      <details>
        <summary>Advanced: WebRTC Dial</summary>
        <div class="row">
          <div>
            <label for="offer">Offer</label>
            <textarea id="offer" rows="4" placeholder="Create or paste offer"></textarea>
            <button id="create-offer">Create Offer</button>
          </div>
          <div>
            <label for="answer">Answer</label>
            <textarea id="answer" rows="4" placeholder="Paste answer"></textarea>
            <button id="accept-answer">Accept Answer</button>
          </div>
        </div>
      </details>
    </div>
    <div class="card">
      <h2>Append to Wiki</h2>
      <label for="page">Page</label>
      <input id="page" value="Welcome" />
      <label for="text">Content</label>
      <textarea id="text" rows="4" placeholder="Add a paragraph..."></textarea>
      <button id="submit">Append</button>
      <p id="status"></p>
    </div>
  </main>
  <script src="/assets/qrcode.min.js"></script>
  <script type="module">
    import { createSession } from "/lib/session.js";
    const content = document.getElementById("content");
    const pageInput = document.getElementById("page");
    const textInput = document.getElementById("text");
    const submit = document.getElementById("submit");
    const status = document.getElementById("status");
    const transportStatus = document.getElementById("transport-status");
    const shareLink = document.getElementById("share-link");
    const shareQr = document.getElementById("share-qr");
    const offer = document.getElementById("offer");
    const answer = document.getElementById("answer");
    const createOfferBtn = document.getElementById("create-offer");
    const acceptAnswerBtn = document.getElementById("accept-answer");
    const session = createSession();
    const sessionId = localStorage.getItem("vg-session") || `vg-${Date.now()}`;
    localStorage.setItem("vg-session", sessionId);

    function parseJsonl(text) {
      return text
        .split(/\r?\n/)
        .map((line) => line.trim())
        .filter(Boolean)
        .map((line) => JSON.parse(line));
    }

    function render(events) {
      const blocks = events
        .filter((evt) => evt.type === "wiki.append" && evt.payload)
        .map((evt) => {
          const page = evt.payload.page || "Untitled";
          const content = evt.payload.content || "";
          return `<h2>${page}</h2><p>${content}</p>`;
        });
      content.innerHTML = blocks.join("");
    }

    async function loadEvents() {
      const source = location.protocol === "file:" ? "../../data/events.jsonl" : "/data/events.jsonl";
      const res = await fetch(source, { cache: "no-store" });
      const text = await res.text();
      render(parseJsonl(text));
    }

    function updateTransportStatus() {
      transportStatus.textContent = session.transportKind;
    }

    async function connectTransport() {
      if (location.protocol === "file:") return;
      session.on((evt) => {
        if (evt.type === "wiki.append") loadEvents();
      });
      await session.connect();
      updateTransportStatus();
      setupManualDial();
    }

    function sendAppend() {
      if (location.protocol === "file:") {
        status.textContent = "Transport not connected.";
        return;
      }
      const page = pageInput.value.trim() || "Welcome";
      const content = textInput.value.trim();
      if (!content) {
        status.textContent = "Content required.";
        return;
      }
      const now = Date.now();
      const evt = {
        id: `evt-wiki-${now}`,
        ts: Math.floor(now / 1000),
        actor: "anon",
        type: "wiki.append",
        space: "wiki",
        payload: { page, block: "paragraph", content },
      };
      try {
        session.send(evt);
      } catch {
        status.textContent = "Invalid event.";
        return;
      }
      textInput.value = "";
      status.textContent = "Appended.";
    }

    submit.addEventListener("click", sendAppend);
    loadEvents();
    connectTransport();

    function renderShare() {
      const link = `${location.origin}${location.pathname}#join=${sessionId}`;
      shareLink.value = link;
      if (window.QRCode) {
        shareQr.innerHTML = "";
        new QRCode(shareQr, { text: link, width: 128, height: 128 });
      }
    }

    function setupManualDial() {
      if (!session.transport.manual) return;
      createOfferBtn.addEventListener("click", async () => {
        offer.value = await session.transport.manual.createOffer();
      });
      acceptAnswerBtn.addEventListener("click", async () => {
        if (!answer.value.trim()) return;
        await session.transport.manual.acceptAnswer(answer.value.trim());
      });
    }

    renderShare();
  </script>
</body>
</html>
