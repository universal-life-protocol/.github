<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shared Forum (Stub)</title>
  <style>
    body { margin: 0; font-family: sans-serif; background: #f7f2ea; color: #2c1f16; }
    header { padding: 16px 20px; background: #fffdf7; border-bottom: 1px solid #e2d7c7; }
    main { padding: 16px 20px; max-width: 900px; }
    .card { background: #fffdf7; border: 1px solid #e2d7c7; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    pre { margin: 0; font-size: 12px; max-height: 240px; overflow: auto; }
  </style>
</head>
<body>
  <header>
    <h1>Shared Forum (Stub)</h1>
    <p>Renders <code>forum.reply</code> events from the shared log.</p>
  </header>
  <main>
    <div class="card"><strong>Transport:</strong> <span id="transport-status">connecting</span></div>
    <div class="card">
      <h2>Share</h2>
      <div class="row">
        <div>
          <label for="share-link">Link</label>
          <input id="share-link" readonly />
        </div>
        <div>
          <label>QR</label>
          <div id="share-qr"></div>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>Reply</h2>
      <label for="thread">Thread</label>
      <input id="thread" value="General" />
      <label for="reply">Reply</label>
      <textarea id="reply" rows="3" placeholder="Add a reply..."></textarea>
      <button id="submit">Post Reply</button>
      <p id="status"></p>
    </div>
    <div class="card" id="threads"></div>
    <div class="card"><pre id="log"></pre></div>
  </main>
  <script src="/assets/qrcode.min.js"></script>
  <script type="module">
    import { createSession } from "/lib/session.js";
    const threads = document.getElementById("threads");
    const log = document.getElementById("log");
    const status = document.getElementById("transport-status");
    const shareLink = document.getElementById("share-link");
    const shareQr = document.getElementById("share-qr");
    const threadInput = document.getElementById("thread");
    const replyInput = document.getElementById("reply");
    const submit = document.getElementById("submit");
    const postStatus = document.getElementById("status");
    const session = createSession();
    const sessionId = localStorage.getItem("vg-session") || `vg-${Date.now()}`;
    localStorage.setItem("vg-session", sessionId);

    function render(events) {
      const replies = events.filter((evt) => evt.type === "forum.reply" && evt.payload);
      const grouped = new Map();
      replies.forEach((evt) => {
        const thread = evt.payload.thread || "General";
        if (!grouped.has(thread)) grouped.set(thread, []);
        grouped.get(thread).push(evt);
      });
      threads.innerHTML = Array.from(grouped.entries()).map(([thread, items]) => {
        const body = items.map((evt) => `<p>${evt.payload.content || ""}</p>`).join("");
        return `<h3>${thread}</h3>${body}`;
      }).join("");
      log.textContent = replies.map((e) => JSON.stringify(e)).join("\n");
    }

    async function loadEvents() {
      const source = location.protocol === "file:" ? "../../data/events.jsonl" : "/data/events.jsonl";
      const res = await fetch(source, { cache: "no-store" });
      const text = await res.text();
      const events = text.split(/\r?\n/).filter(Boolean).map((line) => JSON.parse(line));
      render(events);
    }

    async function connect() {
      if (location.protocol === "file:") return;
      session.on((evt) => {
        if (evt.type === "forum.reply") loadEvents();
      });
      await session.connect();
      status.textContent = session.transportKind;
    }

    function renderShare() {
      const link = `${location.origin}${location.pathname}#join=${sessionId}`;
      shareLink.value = link;
      if (window.QRCode) {
        shareQr.innerHTML = "";
        new QRCode(shareQr, { text: link, width: 128, height: 128 });
      }
    }

    function sendReply() {
      if (location.protocol === "file:") {
        postStatus.textContent = "Transport not connected.";
        return;
      }
      const thread = threadInput.value.trim() || "General";
      const content = replyInput.value.trim();
      if (!content) {
        postStatus.textContent = "Reply required.";
        return;
      }
      const now = Date.now();
      const evt = {
        id: `evt-forum-${now}`,
        ts: Math.floor(now / 1000),
        actor: "anon",
        type: "forum.reply",
        space: "forum",
        payload: { thread, content },
      };
      try {
        session.send(evt);
      } catch {
        postStatus.textContent = "Invalid event.";
        return;
      }
      replyInput.value = "";
      postStatus.textContent = "Posted.";
    }

    submit.addEventListener("click", sendReply);
    loadEvents();
    connect();
    renderShare();
  </script>
</body>
</html>
